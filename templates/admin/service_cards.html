{% extends "admin/base.html" %}

{% block title %}{{ category.title }} - –ö–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–≤–µ–¥–µ–Ω–∏–π - Wazir –ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å{% endblock %}

{% block page_title %}–ö–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–≤–µ–¥–µ–Ω–∏–π: {{ category.title }}{% endblock %}

{% block extra_css %}
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCgctqtqKOus6A6cDJaOBqsyo4-3r3zuQA&libraries=places&language=ru&region=KG" async defer></script>
<style>
/* –¢–∞–±–ª–∏—Ü–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ */
.cards-container {
    padding: 1.5rem;
} 

.cards-card {
    background-color: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    overflow: hidden;
}

.cards-header {
    padding: 1.25rem 1.5rem;
    background: linear-gradient(135deg, var(--color-secondary) 0%, #1e293b 100%);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.cards-title {
    font-weight: 600;
    font-size: 1.25rem;
    display: flex;
    align-items: center;
}

.cards-title i {
    margin-right: 0.75rem;
    font-size: 1.1rem;
    background-color: rgba(255, 255, 255, 0.2);
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
}

.cards-actions {
    display: flex;
    gap: 0.75rem;
}

.search-bar {
    position: relative;
    width: 240px;
}

.search-bar input {
    width: 100%;
    padding: 0.5rem 0.75rem 0.5rem 2.5rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    font-size: 0.875rem;
    color: white;
    transition: all 0.2s ease;
}

.search-bar input::placeholder {
    color: rgba(255, 255, 255, 0.6);
}

.search-bar input:focus {
    outline: none;
    background-color: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.search-bar i {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: rgba(255, 255, 255, 0.6);
}

.action-button {
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(255, 255, 255, 0.1);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.875rem;
    text-decoration: none;
}

.action-button:hover {
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
    text-decoration: none;
}

.action-button i {
    margin-right: 0.5rem;
    font-size: 1rem;
}

.back-button {
    background-color: rgba(255, 255, 255, 0.1);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    padding: 0.5rem 0.75rem;
    text-decoration: none;
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    transition: all 0.2s ease;
}

.back-button:hover {
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
    text-decoration: none;
}

.back-button i {
    margin-right: 0.5rem;
}

.cards-table-container {
    overflow-x: auto;
}

.cards-table {
    width: 100%;
    border-collapse: collapse;
}

.cards-table th,
.cards-table td {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
}

.cards-table th {
    font-weight: 600;
    color: #4b5563;
    background-color: #f9fafb;
    font-size: 0.875rem;
}

.cards-table tbody tr {
    transition: background-color 0.2s ease;
}

.cards-table tbody tr:hover {
    background-color: #f9fafb;
}

.cards-table td {
    color: #4b5563;
    font-size: 0.875rem;
}

.card-info {
    display: flex;
    align-items: center;
}

.card-image {
    width: 48px;
    height: 48px;
    border-radius: 8px;
    background-color: #f3f4f6;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #9ca3af;
    margin-right: 0.75rem;
    overflow: hidden;
}

.card-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.card-details {
    display: flex;
    flex-direction: column;
}

.card-name {
    font-weight: 500;
    color: #1f2937;
    margin-bottom: 0.125rem;
}

.card-address {
    font-size: 0.75rem;
    color: #6b7280;
}

.card-status {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-active {
    background-color: #ecfdf5;
    color: #047857;
}

.status-inactive {
    background-color: #f3f4f6;
    color: #6b7280;
}

.card-date {
    font-size: 0.875rem;
    color: #6b7280;
}

.card-actions {
    display: flex;
    gap: 0.5rem;
}

.card-action {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    background-color: #f3f4f6;
    color: #4b5563;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
}

.card-action:hover {
    background-color: #e5e7eb;
    text-decoration: none;
    color: #4b5563;
}

.card-action.edit:hover {
    background-color: #fef3c7;
    color: #d97706;
}

.card-action.delete:hover {
    background-color: #fee2e2;
    color: #ef4444;
}

.card-action.view {
    background-color: #4f46e5;
    color: white;
}

.card-action.view:hover {
    background-color: #4338ca;
}

.card-action.view-360 {
    background-color: #7c3aed;
    color: white;
}

.card-action.view-360:hover {
    background-color: #6d28d9;
}

.card-action.edit {
    background-color: #f59e0b;
    color: white;
}

.cards-pagination {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-top: 1px solid #e5e7eb;
}

.pagination-info {
    font-size: 0.875rem;
    color: #6b7280;
}

.pagination-pages {
    display: flex;
    gap: 0.25rem;
}

.page-item {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    font-size: 0.875rem;
    color: #4b5563;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
}

.page-item:hover {
    background-color: #f3f4f6;
    text-decoration: none;
    color: #4b5563;
}

.page-item.active {
    background-color: var(--color-primary);
    color: white;
}

.page-item.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.page-item.disabled:hover {
    background-color: transparent;
}

/* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    animation: fadeIn 0.3s ease;
}

.modal.show {
    display: flex !important;
    align-items: center;
    justify-content: center;
}

.modal-backdrop {
    display: none !important;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal-backdrop.show {
    display: flex !important;
}

.modal-content {
    background: white;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow: auto;
}

.modal-header {
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.125rem;
    font-weight: 600;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.25rem;
    cursor: pointer;
    color: #6b7280;
}

.modal-body {
    padding: 1rem;
}

.modal-footer {
    padding: 1rem;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
}

.btn {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    border: none;
    font-weight: 500;
    cursor: pointer;
}

.btn-primary {
    background: #3b82f6;
    color: white;
}

.btn-secondary {
    background: #6b7280;
    color: white;
}

.upload-area {
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.2s;
}

.upload-area:hover {
    border-color: #3b82f6;
}

.upload-area i {
    font-size: 2rem;
    color: #6b7280;
    margin-bottom: 1rem;
}

.upload-hint {
    font-size: 0.875rem;
    color: #6b7280;
    margin: 0.5rem 0 0;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.form-group input {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
}

.form-hint {
    font-size: 0.875rem;
    color: #6b7280;
    margin: 0.25rem 0 0;
}

.photos-preview {
    margin-top: 1rem;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 0.5rem;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
.tour-tab {
    padding: 10px 20px;
    border: none;
    background: none;
    color: #4b5563;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s ease;
}

.tour-tab.active {
    color: #2563eb;
    border-bottom-color: #2563eb;
}

.tour-tab:hover {
    color: #2563eb;
}

.upload-section:hover {
    border-color: #9ca3af;
}

.upload-placeholder:hover i {
    color: #4b5563;
}

.upload-placeholder:hover p {
    color: #4b5563;
}

.tour-360-section {
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 10px;
}

.image-preview {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
}

.image-preview-container {
    position: relative;
    display: inline-block;
}

.image-remove-btn {
    position: absolute;
    top: -5px;
    right: -5px;
    width: 20px;
    height: 20px;
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.image-remove-btn:hover {
    background: #dc2626;
}
</style>
{% endblock %}

{% block content %}
<div class="cards-container">
    <div class="cards-card">
        <div class="cards-header">
            <h2 class="cards-title">
                –ö–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–≤–µ–¥–µ–Ω–∏–π: {{ category.title }}
                <small>({{ service_cards|length }} –∑–∞–≤–µ–¥–µ–Ω–∏–π)</small>
            </h2>
            <div class="cards-actions">
                <button id="add-card-btn" class="btn btn-primary">
                    <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≤–µ–¥–µ–Ω–∏–µ
                </button>
                <button onclick="testMediaServer()" class="btn btn-secondary" style="margin-left: 10px;">
                    <i class="fas fa-network-wired"></i> –¢–µ—Å—Ç –º–µ–¥–∏–∞-—Å–µ—Ä–≤–µ—Ä–∞
                </button>
                <button onclick="testDirectUpload()" class="btn btn-warning" style="margin-left: 10px;">
                    <i class="fas fa-upload"></i> –ü—Ä—è–º–æ–π —Ç–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏
                </button>
                <button onclick="testQuickUpload()" class="btn btn-success" style="margin-left: 10px;">
                    <i class="fas fa-bolt"></i> –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç
                </button>
            </div>
        </div>

        <div class="cards-table-container">
            <table class="cards-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ó–∞–≤–µ–¥–µ–Ω–∏–µ</th>
                        <th>–ö–æ–Ω—Ç–∞–∫—Ç—ã</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for card in service_cards %}
                    <tr>
                        <td>{{ card.id }}</td>
                        <td>
                            <div class="card-info">
                                <div class="card-image">
                                    {% if card.image_url %}
                                    <img src="{{ card.image_url }}" alt="{{ card.title }}">
                                    {% else %}
                                    <i class="fas fa-store"></i>
                                    {% endif %}
                                </div>
                                <div class="card-details">
                                    <div class="card-name">{{ card.title }}</div>
                                    {% if card.address %}
                                    <div class="card-address">{{ card.address }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if card.phone %}
                            <div>üìû {{ card.phone }}</div>
                            {% endif %}
                            {% if card.email %}
                            <div>üìß {{ card.email }}</div>
                            {% endif %}
                        </td>
                        <td>
                            <span class="card-status status-{% if card.is_active %}active{% else %}inactive{% endif %}">
                                {% if card.is_active %}–ê–∫—Ç–∏–≤–Ω–æ{% else %}–ù–µ–∞–∫—Ç–∏–≤–Ω–æ{% endif %}
                            </span>
                        </td>
                        <td class="card-date">{{ card.created_at.strftime('%d.%m.%Y %H:%M') if card.created_at else '' }}</td>
                        <td>
                            <div class="card-actions">
                                <button class="card-action view" onclick="viewCardImages({{ card.id }})" title="–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ ({{ card.images|length if card.images else 0 }})">
                                    <i class="fas fa-camera"></i>
                                </button>
                                <button class="card-action view-360" onclick="manage360Tour({{ card.id }})" title="360¬∞ –ø–∞–Ω–æ—Ä–∞–º–∞{% if card.has_360_tour %} (–∑–∞–≥—Ä—É–∂–µ–Ω–∞){% endif %}">
                                    <i class="fas fa-vr-cardboard"></i>
                                </button>
                                <button class="card-action edit" onclick="editCardFromData(this)" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                                        data-id="{{ card.id }}"
                                        data-title="{{ card.title }}"
                                        data-description="{{ card.description or '' }}"
                                        data-address="{{ card.address or '' }}"
                                        data-phone="{{ card.phone or '' }}"
                                        data-email="{{ card.email or '' }}"
                                        data-website="{{ card.website or '' }}"
                                        data-image="{{ card.image_url or '' }}"
                                        data-active="{{ card.is_active|lower }}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="card-action delete" onclick="deleteCard({{ card.id }}, '{{ card.title }}')" title="–£–¥–∞–ª–∏—Ç—å">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="cards-pagination">
            <div class="pagination-info">
                –ü–æ–∫–∞–∑–∞–Ω–æ 1-{{ service_cards|length }} –∏–∑ {{ service_cards|length }} –∑–∞–≤–µ–¥–µ–Ω–∏–π
            </div>
            <div class="pagination-pages">
                <a href="#" class="page-item disabled">
                    <i class="fas fa-angle-double-left"></i>
                </a>
                <a href="#" class="page-item disabled">
                    <i class="fas fa-angle-left"></i>
                </a>
                <a href="#" class="page-item active">1</a>
                <a href="#" class="page-item disabled">
                    <i class="fas fa-angle-right"></i>
                </a>
                <a href="#" class="page-item disabled">
                    <i class="fas fa-angle-double-right"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ -->
<div id="addCardModal" class="modal">
    <div class="modal-content" style="max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
            <h3 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–≤–µ–¥–µ–Ω–∏–µ</h3>
            <button class="modal-close" onclick="closeModal('addCardModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="addCardForm">
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è *</label>
                    <input type="text" class="form-input" id="addCardTitle" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ..." required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea class="form-textarea" id="addCardDescription" 
                              placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è..." 
                              rows="4" 
                              style="width: 100%; min-height: 100px; resize: vertical; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-family: inherit; font-size: 0.875rem; line-height: 1.5;"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–ê–¥—Ä–µ—Å</label>
                    <input type="text" class="form-input" id="addCardAddress" placeholder="–ê–¥—Ä–µ—Å –∑–∞–≤–µ–¥–µ–Ω–∏—è...">
                </div>
                
                <!-- Google Maps –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç -->
                <div class="form-group">
                    <label class="form-label">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–µ</label>
                    <div id="addCardMap" style="width: 100%; height: 300px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 10px;"></div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label class="form-label" style="font-size: 0.8rem; margin-bottom: 5px;">–®–∏—Ä–æ—Ç–∞</label>
                            <input type="number" step="any" class="form-input" id="addCardLatitude" placeholder="42.8746" readonly>
                        </div>
                        <div>
                            <label class="form-label" style="font-size: 0.8rem; margin-bottom: 5px;">–î–æ–ª–≥–æ—Ç–∞</label>
                            <input type="number" step="any" class="form-input" id="addCardLongitude" placeholder="74.5698" readonly>
                        </div>
                    </div>
                    <small style="color: #6b7280; font-size: 0.8rem;">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è</small>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="tel" class="form-input" id="addCardPhone" placeholder="+996...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="addCardEmail" placeholder="email@example.com">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–í–µ–±-—Å–∞–π—Ç</label>
                    <input type="url" class="form-input" id="addCardWebsite" placeholder="https://...">
                </div>
                
                <!-- –ë–ª–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
                <div class="form-group">
                    <label class="form-label">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≤–µ–¥–µ–Ω–∏—è</label>
                    <div class="upload-section" style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 10px;">
                        <input type="file" id="addCardImages" multiple accept="image/*" style="display: none;">
                        <div class="upload-placeholder" onclick="document.getElementById('addCardImages').click();" style="cursor: pointer;">
                            <i class="fas fa-camera" style="font-size: 2rem; color: #9ca3af; margin-bottom: 10px;"></i>
                            <p style="color: #6b7280; margin: 0;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</p>
                            <small style="color: #9ca3af;">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: JPG, PNG, GIF (–¥–æ 10 —Ñ–∞–π–ª–æ–≤)</small>
                        </div>
                        <div id="addCardImagesPreview" style="display: none; margin-top: 15px;">
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- –ë–ª–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ 360¬∞ –ø–∞–Ω–æ—Ä–∞–º—ã -->
                <div class="form-group">
                    <label class="form-label">360¬∞ –ü–∞–Ω–æ—Ä–∞–º–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <div class="tour-360-section" style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 20px; margin-bottom: 10px;">
                        <div class="tour-360-tabs" style="display: flex; margin-bottom: 15px; border-bottom: 1px solid #e5e7eb;">
                            <button type="button" class="tour-tab active" data-tab="url" style="padding: 10px 20px; border: none; background: none; color: #4b5563; cursor: pointer; border-bottom: 2px solid transparent;">
                                URL —Å—Å—ã–ª–∫–∞
                            </button>
                            <button type="button" class="tour-tab" data-tab="file" style="padding: 10px 20px; border: none; background: none; color: #4b5563; cursor: pointer; border-bottom: 2px solid transparent;">
                                –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
                            </button>
                        </div>
                        
                        <div class="tour-360-url-section" id="tour-url-section">
                            <input type="url" class="form-input" id="addCard360Url" placeholder="https://kuula.co/share/... –∏–ª–∏ –¥—Ä—É–≥–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ 360¬∞ –ø–∞–Ω–æ—Ä–∞–º—É">
                            <small style="color: #6b7280; font-size: 0.8rem;">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Å—Å—ã–ª–∫–∏ –Ω–∞ Kuula, Matterport –∏ –¥—Ä—É–≥–∏–µ —Å–µ—Ä–≤–∏—Å—ã</small>
                        </div>
                        
                        <div class="tour-360-file-section" id="tour-file-section" style="display: none;">
                            <input type="file" id="addCard360File" accept="image/*" style="display: none;">
                            <div class="upload-360-placeholder" onclick="document.getElementById('addCard360File').click();" style="cursor: pointer; text-align: center;">
                                <i class="fas fa-vr-cardboard" style="font-size: 2rem; color: #9ca3af; margin-bottom: 10px;"></i>
                                <p style="color: #6b7280; margin: 0;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ 360¬∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
                                <small style="color: #9ca3af;">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: JPG, PNG (–ø–∞–Ω–æ—Ä–∞–º–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)</small>
                            </div>
                            <div id="addCard360Preview" style="display: none; margin-top: 15px; text-align: center;">
                                <div style="padding: 10px; background: #f3f4f6; border-radius: 6px;">
                                    <i class="fas fa-vr-cardboard" style="color: #4b5563; margin-right: 8px;"></i>
                                    <span id="addCard360FileName" style="color: #4b5563;"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('addCardModal')">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" onclick="submitAddCard()">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–≤–µ–¥–µ–Ω–∏–µ</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ -->
<div id="editCardModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≤–µ–¥–µ–Ω–∏–µ</h3>
            <button class="modal-close" onclick="closeModal('editCardModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editCardForm">
                <input type="hidden" id="editCardId">
                
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è</label>
                    <input type="text" class="form-input" id="editCardTitle" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea class="form-textarea" id="editCardDescription" rows="4" style="width: 100%; min-height: 100px; resize: vertical; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-family: inherit; font-size: 0.875rem;"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–ê–¥—Ä–µ—Å</label>
                    <input type="text" class="form-input" id="editCardAddress">
                </div>
                
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="tel" class="form-input" id="editCardPhone">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="editCardEmail">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–í–µ–±-—Å–∞–π—Ç</label>
                    <input type="url" class="form-input" id="editCardWebsite">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('editCardModal')">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" onclick="submitEditCard()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π -->
<div id="photosModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</h3>
            <button onclick="closeModal('photosModal')" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="photos-card-id" value="">
            <div class="upload-area" onclick="document.getElementById('photos-input').click()">
                <i class="fas fa-camera"></i>
                <p>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</p>
                <p class="upload-hint">–ú–∞–∫—Å–∏–º—É–º 10 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</p>
            </div>
            <input type="file" id="photos-input" multiple accept="image/*" style="display: none;">
            <div id="photos-preview" class="photos-preview"></div>
        </div>
        <div class="modal-footer">
            <button onclick="closeModal('photosModal')" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
            <button onclick="uploadCardPhotos()" class="btn btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è 360¬∞ –ø–∞–Ω–æ—Ä–∞–º—ã -->
<div id="tour360Modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>360¬∞ –ø–∞–Ω–æ—Ä–∞–º–∞</h3>
            <button onclick="closeModal('tour360Modal')" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="tour360-card-id" value="">
            
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–π –ø–∞–Ω–æ—Ä–∞–º–µ -->
            <div id="current-360-info" class="form-group" style="display: none;">
                <div style="background: #f3f4f6; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #374151;">–¢–µ–∫—É—â–∞—è –ø–∞–Ω–æ—Ä–∞–º–∞</h4>
                    <div id="current-360-type" style="font-weight: 500; color: #059669; margin-bottom: 0.25rem;"></div>
                    <div id="current-360-date" style="font-size: 0.875rem; color: #6b7280;"></div>
                    <button type="button" onclick="delete360Tour()" style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; background: #ef4444; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                        <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å –ø–∞–Ω–æ—Ä–∞–º—É
                    </button>
                </div>
            </div>
            
            <!-- –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <div class="form-group">
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <button type="button" id="upload-file-tab" onclick="switchTo360Mode('file')" 
                            style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; background: #f9fafb; border-radius: 6px; cursor: pointer;">
                        <i class="fas fa-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
                    </button>
                    <button type="button" id="upload-url-tab" onclick="switchTo360Mode('url')" 
                            style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer;">
                        <i class="fas fa-link"></i> –£–∫–∞–∑–∞—Ç—å URL
                    </button>
                </div>
            </div>
            
            <!-- –§–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ -->
            <div id="file-upload-360" class="upload-mode">
                <div class="upload-area" style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer; transition: border-color 0.2s;" onclick="document.getElementById('panorama-360-input').click()">
                    <i class="fas fa-vr-cardboard" style="font-size: 2rem; color: #6b7280; margin-bottom: 1rem; display: block;"></i>
                    <p style="margin: 0.5rem 0;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ 360¬∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
                    <p style="font-size: 0.875rem; color: #6b7280; margin: 0;">PNG, JPG, JPEG –¥–æ 100MB. –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω –ø—Ä–∏–º–µ—Ä–Ω–æ 2:1</p>
                </div>
                <input type="file" id="panorama-360-input" accept="image/*" style="display: none;">
                
                <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ -->
                <div id="upload-360-progress" style="margin-top: 1rem; display: none;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>–ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞...</span>
                        <span id="upload-360-percent">0%</span>
                    </div>
                    <div style="width: 100%; background: #e5e7eb; border-radius: 4px; height: 8px;">
                        <div id="upload-360-bar" style="background: #3b82f6; height: 100%; border-radius: 4px; width: 0%; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <!-- –ü—Ä–µ–≤—å—é –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ -->
                <div id="file-360-preview" style="margin-top: 1rem; display: none;">
                    <h4 style="margin: 0 0 0.5rem 0;">–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª:</h4>
                    <div id="file-360-info" style="background: #f3f4f6; padding: 0.75rem; border-radius: 6px;"></div>
                </div>
            </div>
            
            <!-- –§–æ—Ä–º–∞ URL -->
            <div id="url-upload-360" class="upload-mode" style="display: none;">
                <div class="form-group">
                    <label for="tour-360-url">URL 360¬∞ –ø–∞–Ω–æ—Ä–∞–º—ã</label>
                    <input type="url" id="tour-360-url" placeholder="https://kuula.co/share/xxxxxxx" 
                           style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                    <p style="font-size: 0.875rem; color: #6b7280; margin: 0.5rem 0 0;">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Å—Å—ã–ª–∫–∏ —Å Kuula, Matterport –∏ –¥—Ä—É–≥–∏—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º</p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeModal('tour360Modal')" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
            <button onclick="save360Tour()" class="btn btn-primary" id="save-360-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
const categoryId = {{ category.id }};

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è Google Maps
let addCardMap = null;
let addCardMarker = null;

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
let selectedImages = [];
let selected360File = null;

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è 360¬∞ –ø–∞–Ω–æ—Ä–∞–º
let current360Mode = 'file';

// –ü–æ–∏—Å–∫ –∫–∞—Ä—Ç–æ—á–µ–∫ - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞
const searchInput = document.getElementById('card-search-input');
if (searchInput) {
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('.cards-table tbody tr');
        
        rows.forEach(row => {
            const cardName = row.querySelector('.card-name').textContent.toLowerCase();
            const cardAddress = row.querySelector('.card-address');
            const cardAddressText = cardAddress ? cardAddress.textContent.toLowerCase() : '';
            
            if (cardName.includes(searchTerm) || cardAddressText.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Google Maps –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–≤–µ–¥–µ–Ω–∏—è
function initAddCardMap() {
    const defaultLocation = { lat: 42.8746, lng: 74.5698 }; // –ë–∏—à–∫–µ–∫
    
    addCardMap = new google.maps.Map(document.getElementById('addCardMap'), {
        zoom: 13,
        center: defaultLocation,
        mapTypeControl: true,
        streetViewControl: false,
        fullscreenControl: false
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
    addCardMap.addListener('click', function(event) {
        const lat = event.latLng.lat();
        const lng = event.latLng.lng();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        document.getElementById('addCardLatitude').value = lat.toFixed(6);
        document.getElementById('addCardLongitude').value = lng.toFixed(6);
        
        // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–π –º–∞—Ä–∫–µ—Ä
        if (addCardMarker) {
            addCardMarker.setMap(null);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä
        addCardMarker = new google.maps.Marker({
            position: { lat: lat, lng: lng },
            map: addCardMap,
            title: '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è',
            icon: {
                url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
                scaledSize: new google.maps.Size(32, 32)
            }
        });
        
        // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ location: { lat: lat, lng: lng } }, function(results, status) {
            if (status === 'OK' && results[0]) {
                const addressField = document.getElementById('addCardAddress');
                if (!addressField.value) {
                    addressField.value = results[0].formatted_address;
                }
            }
        });
    });
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤ –¥–ª—è 360¬∞
document.addEventListener('DOMContentLoaded', function() {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–∞–±–æ–≤ 360¬∞
    document.querySelectorAll('.tour-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabType = this.getAttribute('data-tab');
            
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö —Ç–∞–±–æ–≤
            document.querySelectorAll('.tour-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å–µ–∫—Ü–∏–∏
            if (tabType === 'url') {
                document.getElementById('tour-url-section').style.display = 'block';
                document.getElementById('tour-file-section').style.display = 'none';
            } else {
                document.getElementById('tour-url-section').style.display = 'none';
                document.getElementById('tour-file-section').style.display = 'block';
            }
        });
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    document.getElementById('addCardImages').addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        if (files.length > 10) {
            alert('–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –º–∞–∫—Å–∏–º—É–º 10 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π');
            return;
        }
        
        selectedImages = files;
        showImagePreviews(files);
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ 360¬∞ —Ñ–∞–π–ª–∞
    document.getElementById('addCard360File').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            selected360File = file;
            document.getElementById('addCard360FileName').textContent = file.name;
            document.getElementById('addCard360Preview').style.display = 'block';
        }
    });
});

// –ü–æ–∫–∞–∑ –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
function showImagePreviews(files) {
    const previewContainer = document.getElementById('addCardImagesPreview');
    const previewDiv = previewContainer.querySelector('div');
    
    previewDiv.innerHTML = '';
    
    files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const imageContainer = document.createElement('div');
            imageContainer.className = 'image-preview-container';
            imageContainer.innerHTML = `
                <img src="${e.target.result}" class="image-preview" alt="–ü—Ä–µ–≤—å—é">
                <button type="button" class="image-remove-btn" onclick="removeImage(${index})">&times;</button>
            `;
            previewDiv.appendChild(imageContainer);
        };
        reader.readAsDataURL(file);
    });
    
    previewContainer.style.display = 'block';
}

// –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –ø—Ä–µ–≤—å—é
function removeImage(index) {
    selectedImages.splice(index, 1);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º input —Ñ–∞–π–ª–æ–≤
    const dt = new DataTransfer();
    selectedImages.forEach(file => dt.items.add(file));
    document.getElementById('addCardImages').files = dt.files;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é
    if (selectedImages.length > 0) {
        showImagePreviews(selectedImages);
    } else {
        document.getElementById('addCardImagesPreview').style.display = 'none';
    }
}

// –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
function openModal(modalId) {
    document.getElementById(modalId).classList.add('show');
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    if (modalId === 'addCardModal') {
        setTimeout(() => {
            if (typeof google !== 'undefined') {
                initAddCardMap();
            }
        }, 300);
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.style.display = 'none';
    modal.classList.remove('show');
    
    // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    if (modalId === 'addCardModal') {
        document.getElementById('addCardForm').reset();
        document.getElementById('addCardImagesPreview').style.display = 'none';
        document.getElementById('addCard360Preview').style.display = 'none';
        selectedImages = [];
        selected360File = null;
        addCardMap = null;
        addCardMarker = null;
    }
    
    // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π
    if (modalId === 'photosModal') {
        document.getElementById('photos-input').value = '';
        document.getElementById('photos-preview').innerHTML = '';
    } else if (modalId === 'tour360Modal') {
        document.getElementById('tour-360-url').value = '';
    }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ 360¬∞
function switchTo360Mode(mode) {
    current360Mode = mode;
    
    const fileTab = document.getElementById('upload-file-tab');
    const urlTab = document.getElementById('upload-url-tab');
    const fileForm = document.getElementById('file-upload-360');
    const urlForm = document.getElementById('url-upload-360');
    
    if (mode === 'file') {
        fileTab.style.background = '#f9fafb';
        urlTab.style.background = 'white';
        fileForm.style.display = 'block';
        urlForm.style.display = 'none';
    } else {
        fileTab.style.background = 'white';
        urlTab.style.background = '#f9fafb';
        fileForm.style.display = 'none';
        urlForm.style.display = 'block';
    }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
const addCardButton = document.getElementById('add-card-btn');
if (addCardButton) {
    addCardButton.addEventListener('click', function() {
        openModal('addCardModal');
    });
}

function submitAddCard() {
    const title = document.getElementById('addCardTitle').value;
    const description = document.getElementById('addCardDescription').value;
    const address = document.getElementById('addCardAddress').value;
    const phone = document.getElementById('addCardPhone').value;
    const email = document.getElementById('addCardEmail').value;
    const website = document.getElementById('addCardWebsite').value;
    const latitude = document.getElementById('addCardLatitude').value;
    const longitude = document.getElementById('addCardLongitude').value;
    const tour360Url = document.getElementById('addCard360Url').value;
    
    if (!title) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è');
        return;
    }
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    const formData = new FormData();
    formData.append('category_id', categoryId);
    formData.append('title', title);
    formData.append('description', description);
    formData.append('address', address);
    formData.append('phone', phone);
    formData.append('email', email);
    formData.append('website', website);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    if (latitude && longitude) {
        formData.append('latitude', parseFloat(latitude));
        formData.append('longitude', parseFloat(longitude));
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º 360¬∞ –ø–∞–Ω–æ—Ä–∞–º—É –µ—Å–ª–∏ –µ—Å—Ç—å
    if (tour360Url) {
        formData.append('tour_360_url', tour360Url);
    } else if (selected360File) {
        formData.append('tour_360_file', selected360File);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å
    if (selectedImages.length > 0) {
        selectedImages.forEach((file, index) => {
            formData.append('images', file);
        });
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
    fetch('/api/v1/admin/service-cards', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success || data.id) {
            alert('–ó–∞–≤–µ–¥–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!');
            location.reload();
        } else {
            alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–≤–µ–¥–µ–Ω–∏—è');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–≤–µ–¥–µ–Ω–∏—è');
    });
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤
function editCardFromData(button) {
    const data = button.dataset;
    editCard(
        data.id,
        data.title,
        data.description,
        data.address,
        data.phone,
        data.email,
        data.website,
        data.image,
        data.active === 'true'
    );
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
function editCard(id, title, description, address, phone, email, website, image_url, is_active) {
    document.getElementById('editCardId').value = id;
    document.getElementById('editCardTitle').value = title || '';
    document.getElementById('editCardDescription').value = description || '';
    document.getElementById('editCardAddress').value = address || '';
    document.getElementById('editCardPhone').value = phone || '';
    document.getElementById('editCardEmail').value = email || '';
    document.getElementById('editCardWebsite').value = website || '';
    
    openModal('editCardModal');
}

function submitEditCard() {
    const id = document.getElementById('editCardId').value;
    const formData = {
        title: document.getElementById('editCardTitle').value,
        description: document.getElementById('editCardDescription').value,
        address: document.getElementById('editCardAddress').value,
        phone: document.getElementById('editCardPhone').value,
        email: document.getElementById('editCardEmail').value,
        website: document.getElementById('editCardWebsite').value,
        is_active: true // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∞–∫—Ç–∏–≤–Ω–æ
    };
    
    if (!formData.title) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è');
        return;
    }
    
    fetch(`/api/v1/admin/service-cards/${id}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('–ó–∞–≤–µ–¥–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!');
            location.reload();
        } else {
            alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–≤–µ–¥–µ–Ω–∏—è');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–≤–µ–¥–µ–Ω–∏—è');
    });
}

// –£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
function deleteCard(id, title) {
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–≤–µ–¥–µ–Ω–∏–µ "${title}"?`)) {
        fetch(`/api/v1/admin/service-cards/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('–ó–∞–≤–µ–¥–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ!');
                location.reload();
            } else {
                alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–≤–µ–¥–µ–Ω–∏—è');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–≤–µ–¥–µ–Ω–∏—è');
        });
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏
window.addEventListener('click', function(event) {
    // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
    if (event.target.classList.contains('modal')) {
        event.target.classList.remove('show');
        event.target.style.display = 'none';
    }
    
    // –î–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω —Å backdrop
    if (event.target.classList.contains('modal-backdrop')) {
        event.target.classList.remove('show');
        event.target.style.display = 'none';
        
        // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        if (event.target.id === 'photosModal') {
            document.getElementById('photos-input').value = '';
            document.getElementById('photos-preview').innerHTML = '';
        } else if (event.target.id === 'tour360Modal') {
            document.getElementById('tour-360-url').value = '';
        }
    }
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ –∑–∞–≤–µ–¥–µ–Ω–∏—è
function viewCardImages(cardId) {
    document.getElementById('photos-card-id').value = cardId;
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–∏—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è—Ö
    fetch(`/api/v1/admin/service-cards/${cardId}/media`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.photos && data.photos.count > 0) {
                console.log(`–£ –∑–∞–≤–µ–¥–µ–Ω–∏—è ${data.photos.count} —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π. –ü–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–≥—Ä—É–∑–∫–∞: ${data.photos.last_uploaded || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`);
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è—Ö:', error);
        });
    
    openModal('photosModal');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è 360¬∞ —Ç—É—Ä–æ–º —Å –∑–∞–≥—Ä—É–∑–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
function manage360Tour(cardId) {
    document.getElementById('tour360-card-id').value = cardId;
    
    // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
    current360Mode = 'file';
    selected360File = null;
    document.getElementById('panorama-360-input').value = '';
    document.getElementById('tour-360-url').value = '';
    document.getElementById('file-360-preview').style.display = 'none';
    document.getElementById('upload-360-progress').style.display = 'none';
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Ä–µ–∂–∏–º —Ñ–∞–π–ª–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    switchTo360Mode('file');
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–π –ø–∞–Ω–æ—Ä–∞–º–µ
    fetch(`/api/v1/admin/service-cards/${cardId}/media`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.tour_360 && data.tour_360.has_tour) {
                const info = data.tour_360;
                document.getElementById('current-360-info').style.display = 'block';
                
                const typeText = info.type === 'file' ? '–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª' : '–í–Ω–µ—à–Ω—è—è —Å—Å—ã–ª–∫–∞';
                document.getElementById('current-360-type').textContent = typeText;
                
                const dateText = info.last_uploaded ? 
                    `–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${new Date(info.last_uploaded).toLocaleString('ru-RU')}` : 
                    '–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞';
                document.getElementById('current-360-date').textContent = dateText;
                
                // –ï—Å–ª–∏ —ç—Ç–æ URL, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Ä–µ–∂–∏–º URL –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ
                if (info.type === 'url' && info.url) {
                    switchTo360Mode('url');
                    document.getElementById('tour-360-url').value = info.url;
                }
            } else {
                document.getElementById('current-360-info').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ 360¬∞:', error);
            document.getElementById('current-360-info').style.display = 'none';
        });
    
    openModal('tour360Modal');
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∑–∞–≤–µ–¥–µ–Ω–∏—è
function uploadCardPhotos() {
    const cardId = document.getElementById('photos-card-id').value;
    const fileInput = document.getElementById('photos-input');
    const files = fileInput.files;
    
    console.log('DEBUG: –ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π');
    console.log('DEBUG: Card ID:', cardId);
    console.log('DEBUG: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤:', files.length);
    
    if (files.length === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏');
        return;
    }
    
    if (files.length < 2) {
        alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏');
        return;
    }
    
    const formData = new FormData();
    for (let i = 0; i < files.length; i++) {
        formData.append('photos', files[i]);
        console.log(`DEBUG: –î–æ–±–∞–≤–ª–µ–Ω —Ñ–∞–π–ª ${i+1}: ${files[i].name}, —Ä–∞–∑–º–µ—Ä: ${files[i].size} –±–∞–π—Ç`);
    }
    
    console.log('DEBUG: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞:', `/api/v1/admin/service-cards/${cardId}/photos`);
    
    fetch(`/api/v1/admin/service-cards/${cardId}/photos`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('DEBUG: –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç, —Å—Ç–∞—Ç—É—Å:', response.status);
        console.log('DEBUG: Headers:', response.headers);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
        if (!response.ok) {
            console.error('DEBUG: –û—à–∏–±–∫–∞ HTTP:', response.status, response.statusText);
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        const contentType = response.headers.get("content-type");
        console.log('DEBUG: Content-Type:', contentType);
        
        if (!contentType || !contentType.includes("application/json")) {
            console.error('DEBUG: –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π Content-Type:', contentType);
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            return response.text().then(text => {
                console.error('DEBUG: –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç–≤–µ—Ç–∞ –∫–∞–∫ —Ç–µ–∫—Å—Ç:', text);
                throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON –æ—Ç–≤–µ—Ç');
            });
        }
        
        return response.json();
    })
    .then(data => {
        console.log('DEBUG: –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ JSON:', data);
        
        if (data && data.success) {
            console.log('DEBUG: –£—Å–ø–µ—à–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞:', data.message);
            alert(data.message);
            closeModal('photosModal');
            location.reload();
        } else {
            console.error('DEBUG: –û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö:', data);
            const errorMsg = data && data.message ? data.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
            alert('–û—à–∏–±–∫–∞: ' + errorMsg);
        }
    })
    .catch(error => {
        console.error('DEBUG: –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞:', error);
        console.error('DEBUG: –¢–∏–ø –æ—à–∏–±–∫–∏:', typeof error);
        console.error('DEBUG: –°—Ç–µ–∫ –æ—à–∏–±–∫–∏:', error.stack);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π: ' + error.message);
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è 360¬∞ –ø–∞–Ω–æ—Ä–∞–º—ã
function save360Tour() {
    const cardId = document.getElementById('tour360-card-id').value;
    const saveBtn = document.getElementById('save-360-btn');
    
    if (current360Mode === 'file') {
        if (!selected360File) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏');
            return;
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
        const formData = new FormData();
        formData.append('file', selected360File);
        
        saveBtn.disabled = true;
        saveBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        const progressDiv = document.getElementById('upload-360-progress');
        const progressBar = document.getElementById('upload-360-bar');
        const progressPercent = document.getElementById('upload-360-percent');
        
        progressDiv.style.display = 'block';
        
        const xhr = new XMLHttpRequest();
        
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percent = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percent + '%';
                progressPercent.textContent = percent + '%';
            }
        });
        
        xhr.addEventListener('load', function() {
            if (xhr.status === 200) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        alert('360¬∞ –ø–∞–Ω–æ—Ä–∞–º–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!');
                        closeModal('tour360Modal');
                        location.reload();
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + (response.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    }
                } catch (e) {
                    alert('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
            } else {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + xhr.status);
            }
            
            saveBtn.disabled = false;
            saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            progressDiv.style.display = 'none';
        });
        
        xhr.addEventListener('error', function() {
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞');
            saveBtn.disabled = false;
            saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            progressDiv.style.display = 'none';
        });
        
        xhr.open('POST', `/api/v1/admin/service-cards/${cardId}/360/upload`);
        xhr.send(formData);
        
    } else {
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ URL
        const url = document.getElementById('tour-360-url').value.trim();
        
        if (!url) {
            alert('–í–≤–µ–¥–∏—Ç–µ URL 360¬∞ –ø–∞–Ω–æ—Ä–∞–º—ã');
            return;
        }
        
        const formData = new FormData();
        formData.append('tour_360_url', url);
        
        saveBtn.disabled = true;
        saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        
        fetch(`/api/v1/admin/service-cards/${cardId}/360`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('360¬∞ –ø–∞–Ω–æ—Ä–∞–º–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
                closeModal('tour360Modal');
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
        })
        .finally(() => {
            saveBtn.disabled = false;
            saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        });
    }
}

// –£–¥–∞–ª–µ–Ω–∏–µ 360¬∞ –ø–∞–Ω–æ—Ä–∞–º—ã
function delete360Tour() {
    const cardId = document.getElementById('tour360-card-id').value;
    
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å 360¬∞ –ø–∞–Ω–æ—Ä–∞–º—É?')) {
        const formData = new FormData();
        formData.append('tour_360_url', '');
        
        fetch(`/api/v1/admin/service-cards/${cardId}/360`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('360¬∞ –ø–∞–Ω–æ—Ä–∞–º–∞ —É–¥–∞–ª–µ–Ω–∞');
                closeModal('tour360Modal');
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
        });
    }
}

// –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–∏–∞-—Å–µ—Ä–≤–µ—Ä–∞
function testMediaServer() {
    console.log('DEBUG: –¢–µ—Å—Ç–∏—Ä—É–µ–º –º–µ–¥–∏–∞-—Å–µ—Ä–≤–µ—Ä...');
    
    fetch('/api/v1/admin/test-media-server')
    .then(response => {
        console.log('DEBUG: –û—Ç–≤–µ—Ç –æ—Ç —Ç–µ—Å—Ç-—ç–Ω–¥–ø–æ–∏–Ω—Ç–∞:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('DEBUG: –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞ –º–µ–¥–∏–∞-—Å–µ—Ä–≤–µ—Ä–∞:', data);
        
        if (data.success) {
            const connection = data.connection ? '–û–ö' : '–û–®–ò–ë–ö–ê';
            const message = `–ú–µ–¥–∏–∞-—Å–µ—Ä–≤–µ—Ä: ${connection}\n\n–î–µ—Ç–∞–ª–∏:\n${JSON.stringify(data.media_server_status, null, 2)}`;
            alert(message);
        } else {
            alert('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ' + data.error);
        }
    })
    .catch(error => {
        console.error('DEBUG: –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –º–µ–¥–∏–∞-—Å–µ—Ä–≤–µ—Ä–∞: ' + error.message);
    });
}

// –ü—Ä—è–º–æ–π —Ç–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
function testDirectUpload() {
    console.log('DEBUG: –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä—è–º–æ–π —Ç–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏...');
    
    // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π input –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
    const input = document.createElement('input');
    input.type = 'file';
    input.multiple = true;
    input.accept = 'image/*';
    
    input.onchange = function(e) {
        const files = e.target.files;
        if (files.length === 0) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
            return;
        }
        
        console.log(`DEBUG: –í—ã–±—Ä–∞–Ω–æ ${files.length} —Ñ–∞–π–ª–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∞`);
        
        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('photos', files[i]);
            console.log(`DEBUG: –î–æ–±–∞–≤–ª–µ–Ω —Ñ–∞–π–ª: ${files[i].name}`);
        }
        
        console.log('DEBUG: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø—Ä—è–º–æ–π —Ç–µ—Å—Ç...');
        
        fetch('/api/v1/admin/test-direct-upload', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            console.log('DEBUG: –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('DEBUG: –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä—è–º–æ–≥–æ —Ç–µ—Å—Ç–∞:', data);
            
            if (data.success) {
                alert(`‚úÖ –ü—Ä—è–º–æ–π —Ç–µ—Å—Ç —É—Å–ø–µ—à–µ–Ω!\n\n–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: ${data.files_sent}\n–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${JSON.stringify(data.server_response, null, 2)}`);
            } else {
                alert(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä—è–º–æ–≥–æ —Ç–µ—Å—Ç–∞:\n${data.error}`);
            }
        })
        .catch(error => {
            console.error('DEBUG: –û—à–∏–±–∫–∞ –ø—Ä—è–º–æ–≥–æ —Ç–µ—Å—Ç–∞:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø—Ä—è–º–æ–≥–æ —Ç–µ—Å—Ç–∞: ' + error.message);
        });
    };
    
    input.click();
}

// –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏
function testQuickUpload() {
    console.log('DEBUG: –ó–∞–ø—É—Å–∫–∞–µ–º –±—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏...');
    
    const input = document.createElement('input');
    input.type = 'file';
    input.multiple = true;
    input.accept = 'image/*';
    
    input.onchange = function(e) {
        const files = e.target.files;
        if (files.length === 0) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∞');
            return;
        }
        
        console.log(`DEBUG: –í—ã–±—Ä–∞–Ω–æ ${files.length} —Ñ–∞–π–ª–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∞`);
        
        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('photos', files[i]);
            console.log(`DEBUG: –î–æ–±–∞–≤–ª–µ–Ω —Ñ–∞–π–ª: ${files[i].name}`);
        }
        
        console.log('DEBUG: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ /api/v1/admin/test-quick-upload');
        
        fetch('/api/v1/admin/test-quick-upload', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            console.log('DEBUG: –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('DEBUG: –†–µ–∑—É–ª—å—Ç–∞—Ç –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∞:', data);
            
            if (data.error) {
                alert(`‚ùå –û—à–∏–±–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∞:\n${data.error}`);
            } else {
                alert(`‚ö° –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!\n\n–°—Ç–∞—Ç—É—Å –∫–æ–¥: ${data.status_code}\n–§–∞–π–ª–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${data.files_sent}\n\n–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:\n${data.response}`);
            }
        })
        .catch(error => {
            console.error('DEBUG: –û—à–∏–±–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∞:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∞: ' + error.message);
        });
    };
    
    input.click();
}

// Event listener –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ 360¬∞ —Ñ–∞–π–ª–æ–≤
document.getElementById('panorama-360-input').addEventListener('change', function(e) {
    const files = e.target.files;
    const previewDiv = document.getElementById('file-360-preview');
    const infoDiv = document.getElementById('file-360-info');
    
    if (files.length > 0) {
        const file = files[0];
        selected360File = file;
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–∞
        const maxSize = 100 * 1024 * 1024; // 100MB
        if (file.size > maxSize) {
            alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 100MB');
            this.value = '';
            selected360File = null;
            previewDiv.style.display = 'none';
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
        if (!file.type.startsWith('image/')) {
            alert('–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
            this.value = '';
            selected360File = null;
            previewDiv.style.display = 'none';
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
        const fileSize = file.size < 1024 * 1024 ? 
            `${(file.size / 1024).toFixed(1)} KB` : 
            `${(file.size / (1024 * 1024)).toFixed(1)} MB`;
            
        infoDiv.innerHTML = `
            <strong>–§–∞–π–ª:</strong> ${file.name}<br>
            <strong>–†–∞–∑–º–µ—Ä:</strong> ${fileSize}<br>
            <strong>–¢–∏–ø:</strong> ${file.type}
        `;
        
        previewDiv.style.display = 'block';
        console.log('360¬∞ —Ñ–∞–π–ª –≤—ã–±—Ä–∞–Ω:', file.name, fileSize);
    } else {
        selected360File = null;
        previewDiv.style.display = 'none';
    }
});
</script>
{% endblock %} 