{% extends "layout/base.html" %}

{% block title %}Wazir Недвижимость - {{ property.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css" />
<!-- Pannellum for 360° panorama viewing -->
<script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css" />
<style>
    .btn favorite-btn {
        width: 100%;
    }
    #view-360-btn {
        width: 100%;
    }
    .btn favorite-btn {
        width: 100%;
    }
    .bottom-nav {
        box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    }
    .nav-item {
        transition: all 0.2s ease;
    }
    .nav-item.active {
        color: var(--color-primary);
    }
    .nav-item:hover {
        color: var(--color-primary-hover);
    }
    .nav-icons {
        font-size: 1.6rem;
        font-weight: 300;
    }
    .weather-currency {
        font-size: 1.1rem;
        font-weight: 500;
    }
    .weather-icon {
        font-size: 1.4rem;
    }
    .swiper {
        width: 100%;
        height: 280px;
        border-radius: 0;
        overflow: hidden;
    }
    .swiper-slide {
        position: relative;
        background-color: #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #9ca3af;
        font-size: 1.3rem;
    }
    .swiper-slide img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .thumbnails-container {
        display: flex;
        overflow-x: auto;
        gap: 8px;
        padding: 10px 0;
        margin-top: 10px;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: #cbd5e0 #f3f4f6;
    }
    .thumbnails-container::-webkit-scrollbar {
        height: 6px;
    }
    .thumbnails-container::-webkit-scrollbar-track {
        background: #f3f4f6;
    }
    .thumbnails-container::-webkit-scrollbar-thumb {
        background-color: #cbd5e0;
        border-radius: 3px;
    }
    .thumbnail {
        flex: 0 0 auto;
        width: 80px;
        height: 70px;
        background-color: #f3f4f6;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #9ca3af;
        font-size: 1rem;
        cursor: pointer;
        opacity: 0.6;
        transition: opacity 0.2s ease;
        border: 1px solid #e5e7eb;
    }
    .thumbnail.active {
        opacity: 1;
        border-color: #9ca3af;
    }
    .thumbnail:hover {
        opacity: 0.8;
    }
    .action-buttons .btn {
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        padding: 8px 12px;
        font-size: 0.9rem;
        background-color: #f9fafb;
        color: #4b5563;
        width: 100%;
    }
    .property-id {
        color: #9ca3af;
        font-size: 1rem;
        font-weight: 400;
    }
    .property-price {
        font-size: 1.6rem;
        font-weight: 600;
        color: #111827;
    }
    .property-specs {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }
    .property-spec {
        display: flex;
        align-items: center;
        padding: 6px 10px;
        border-radius: 4px;
        background-color: #f3f4f6;
        color: #6b7280;
        font-size: 1rem;
    }
    .property-description {
        font-size: 1.05rem;
        line-height: 1.5;
        color: #4b5563;
    }
    .info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }
    .info-item {
        display: flex;
        align-items: center;
        font-size: 1rem;
        color: #4b5563;
        padding: 4px 0;
    }
    .info-item i {
        width: 20px;
        margin-right: 8px;
        color: #9ca3af;
    }
    .action-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 12px;
        font-weight: 500;
        border-radius: 4px;
        font-size: 1.05rem;
        width: 100%;
        transition: all 0.2s ease;
    }
    .action-btn.primary {
        background-color: #f3f4f6;
        color: #4b5563;
        border: 1px solid #e5e7eb;
    }
    .action-btn.secondary {
        background-color: #f3f4f6;
        color: #4b5563;
        border: 1px solid #e5e7eb;
    }
    .seller-info {
        display: flex;
        align-items: center;
        padding: 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 16px;
    }
    .avatar {
        width: 50px;
        height: 50px;
        border-radius: 25px;
        overflow: hidden;
        margin-right: 12px;
    }
    .avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .seller-name {
        font-weight: 500;
        font-size: 1.05rem;
        color: #111827;
    }
    .seller-info .call-btn {
        margin-left: auto;
        padding: 8px 14px;
        border-radius: 4px;
        background-color: #f3f4f6;
        color: #4b5563;
        font-size: 0.95rem;
        border: 1px solid #e5e7eb;
    }
    .similar-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin: 24px 0 16px;
        color: #111827;
    }
    .property-card {
        border-radius: 8px;
        overflow: hidden;
        background-color: white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .property-card-img {
        height: 120px;
        overflow: hidden;
    }
    .property-card-img img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .property-card-body {
        padding: 10px;
    }
    .property-card-title {
        font-size: 0.9rem;
        font-weight: 500;
        color: #111827;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .property-card-price {
        font-size: 1rem;
        font-weight: 600;
        color: #111827;
        margin-top: 2px;
    }
    .property-card-address {
        font-size: 0.8rem;
        color: #6b7280;
        margin-top: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .property-card-specs {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 6px;
        font-size: 0.8rem;
        color: #6b7280;
    }
    .property-card-spec {
        display: flex;
        align-items: center;
    }
    .property-card-spec i {
        margin-right: 3px;
        font-size: 0.75rem;
    }
    /* 360 просмотр */
    .tour-360-container {
        width: 100%;
        height: 300px;
        background-color: #f3f4f6;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
    }
    .tour-360-disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }
    .favorite-btn {
        background-color: white;
        border: 1px solid #e5e7eb;
        color: #4b5563;
    }
    .favorite-btn.active {
        color: #ef4444;
    }
    iframe {
        width: 100%;
        height: 100%;
        border: none;
    }
    .publication-info {
        border: 1px solid #e5e7eb;
    }
    .publication-info h3 {
        margin-bottom: 12px;
        font-size: 1.1rem;
    }
    .publication-info .grid > div {
        padding: 8px 0;
        border-bottom: 1px solid #f3f4f6;
    }
    .publication-info .grid > div:last-child {
        border-bottom: none;
    }
    /* Стили для переключателя валют */
    .currency-toggle {
        cursor: pointer;
        user-select: none;
        transition: all 0.2s ease;
    }
    .currency-toggle:hover {
        color: #4b5563;
    }
    .currency-arrow {
        margin-left: 6px;
        font-size: 0.8rem;
        color: #9ca3af;
        transition: transform 0.2s ease;
    }
    .currency-toggle:hover .currency-arrow {
        color: #4b5563;
    }
    /* Стили для выпадающего списка валют */
    .currency-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        z-index: 10;
        min-width: 80px;
        display: none;
    }
    .currency-dropdown.show {
        display: block;
    }
    .currency-option {
        padding: 8px 12px;
        cursor: pointer;
        font-size: 0.9rem;
        color: #4b5563;
        transition: background-color 0.2s ease;
    }
    .currency-option:hover {
        background-color: #f3f4f6;
    }
    .currency-option.active {
        color: #2563eb;
        font-weight: 500;
    }
    .currency-container-wrapper {
        position: relative;
        display: inline-block;
    }
    
    /* Стили для рекламного слайдера */
    .ads-slider {
        width: 100%;
        height: 85px;
        position: relative;
        overflow: hidden;
        border-radius: 8px;
        padding: 0 7px;
        margin: 7px 0;
    }
    
    .ads-slider-container {
        width: 100%;
        height: 100%;
        position: relative;
        overflow: hidden;
        border-radius: 8px;
    }
    
    .ads-slides-wrapper {
        display: flex;
        width: 200%; /* 2 слайда = 200% */
        height: 100%;
        transition: transform 0.5s ease-in-out;
    }
    
    .ads-slide {
        width: 50%; /* Каждый слайд занимает 50% от wrapper */
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .ads-slide.placeholder {
        background-color: #9ca3af;
        color: white;
        font-size: 1.2rem;
        font-weight: 500;
        text-align: center;
        font-family: 'Montserrat', sans-serif;
    }
    
    .ads-slide img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    /* Google Maps стили */
    .property-map-container {
        width: 100%;
        height: 300px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        overflow: hidden;
        margin: 16px 0;
    }
    
    .map-section {
        background-color: white;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        border: 1px solid #e5e7eb;
    }
    
    .map-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    
    .map-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #111827;
        display: flex;
        align-items: center;
    }
    
    .map-title i {
        margin-right: 8px;
        color: #4b5563;
    }
    
    .map-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
    }
    
    .map-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px 12px;
        background-color: #f3f4f6;
        color: #4b5563;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        text-decoration: none;
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }
    
    .map-btn:hover {
        background-color: #e5e7eb;
        color: #374151;
    }
    
    .map-btn i {
        margin-right: 6px;
    }
</style>
{% endblock %}

{% block content %}
<div class="pb-20">
    <!-- Рекламный слайдер -->
    <div class="ads-slider rounded-lg">
        <div class="ads-slider-container">
            <div class="ads-slides-wrapper">
                <div class="ads-slide placeholder">
                    Место для вашей рекламы
                </div>
                <div class="ads-slide">
                    <img src="https://wazir.kg/static/reklama.png" alt="wazir">
                </div>
            </div>
        </div>
    </div>
    <!-- Слайдер изображений -->
    <div class="property-slider">
        <div class="swiper main-swiper">
            <div class="swiper-wrapper">
                {% if property.images %}
                {% for image in property.images %}
                <div class="swiper-slide">
                    <img src="{{ image.url }}" alt="Фото объекта">
                </div>
                {% endfor %}
                {% else %}
                <div class="swiper-slide">
                    <img
                        src="{{ url_for('static', path='layout/assets/img/property-placeholder.jpg') }}"
                        alt="Фото отсутствует">
                </div>
                {% endif %}
            </div>
            <div
                class="swiper-pagination absolute bottom-2 left-0 right-0 flex justify-center"></div>
        </div>
    </div>

    <!-- Контент -->
    <div class="property-content mt-2">
        <div class="container mx-auto px-4">
            <div class="thumbnails-container">
                {% if property.images %}
                {% for image in property.images %}
                <div
                    class="thumbnail {% if loop.first %}active{% endif %}"
                    data-index="{{ loop.index0 }}">
                    <img src="{{ image.url }}" alt="Миниатюра">
                </div>
                {% endfor %}
                {% else %}
                <div class="thumbnail active" data-index="0">
                    <img
                        src="{{ url_for('static', path='layout/assets/img/property-placeholder.jpg') }}"
                        alt="Миниатюра">
                </div>
                {% endif %}
            </div>

            <!-- Кнопки действий -->
            <div
                class="action-buttons grid grid-cols-2 gap-3 mt-4 mb-6">
                <button
                    class="btn favorite-btn {% if property.is_favorite %}active{% endif %}"
                    id="favorite-btn"
                    data-property-id="{{ property.id }}">
                    <i
                        class="{% if property.is_favorite %}fas{% else %}far{% endif %} fa-heart mr-1"></i>
                    <span id="favorite-text">{% if
                        property.is_favorite %}В избранном{% else
                        %}В избранное{% endif %}</span>
                </button>
                <!-- Показываем кнопку с разными стилями в зависимости от наличия панорамы -->
                {% if property.has_360 %}
                <button class="btn" id="view-360-btn">
                    <i class="fas fa-vr-cardboard mr-1"></i> 360°
                    Просмотр
                </button>
                {% else %}
                <button class="btn tour-360-disabled" disabled>
                    <i class="fas fa-vr-cardboard mr-1"></i> 360°
                    Недоступно
                </button>
                {% endif %}
                <button class="btn" id="whatsapp-btn">
                    <i class="fab fa-whatsapp mr-1"></i> WhatsApp
                </button>
                <button class="btn" id="share-btn">
                    <i class="fas fa-share-alt mr-1"></i> Поделиться
                </button>
            </div>

            <!-- Информация об объявлении -->
            <div class="property-header mb-4">
                <h1
                    class="text-2xl font-semibold text-gray-900 mt-1">
                    {{ property.title }}
                </h1>
                <div class="property-price mt-2 flex items-center justify-between">
                    <div>
                        <span id="price-value">{{ '{:,.0f}'.format(property.price) }}</span> 
                        <div class="currency-container-wrapper">
                            <span class="text-gray-600 currency-toggle" id="currency-container" style="display: flex; align-items: center;">
                                <span id="currency-label">СОМ</span>
                                <i class="fas fa-chevron-down currency-arrow"></i>
                            </span>
                            <div class="currency-dropdown" id="currency-dropdown">
                                <div class="currency-option active" data-currency="СОМ">СОМ</div>
                                <div class="currency-option" data-currency="USD">USD</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Описание -->
            <div class="property-description mb-6">
                <h3 class="text-gray-800 font-medium mb-2">
                    Описание
                </h3>
                <p class="text-gray-600">
                    {{ property.description }}
                </p>
            </div>
            <div class="property-id">ID Объявления: #{{ property.id }}</div>

            {% if property.is_owner and property.notes %}
            <div class="mt-2 text-green-600">
                <i class="fas fa-calendar-check mr-1"></i> Дата
                съемки 360: {{ property.notes }}
            </div>
            {% endif %}

            <!-- Подробная информация -->
            <div class="mb-6">
                <h3 class="text-gray-800 font-medium mb-3">
                    Характеристики
                </h3>
                <div class="info-grid">
                    {% if property.type %}
                    <div class="info-item">
                        <i class="fas fa-home"></i>
                        <span>{{ property.type_display or property.type|capitalize }}</span>
                    </div>
                    {% endif %}
                    {% if property.category %}
                    <div class="info-item">
                        <i class="fas fa-tag"></i>
                        <span>{{ property.category.name }}</span>
                    </div>
                    {% endif %}
                    {% if property.rooms %}
                    <div class="info-item">
                        <i class="fas fa-door-open"></i>
                        <span>{{ property.rooms }} комнат</span>
                    </div>
                    {% endif %}
                    {% if property.area %}
                    <div class="info-item">
                        <i class="fas fa-vector-square"></i>
                        <span>{{ property.area }} м²</span>
                    </div>
                    {% endif %}
                    {% if property.floor %}
                    <div class="info-item">
                        <i class="fas fa-level-up-alt"></i>
                        <span>{{ property.floor }} этаж</span>
                    </div>
                    {% endif %}
                    {% if property.building_floors %}
                    <div class="info-item">
                        <i class="fas fa-building"></i>
                        <span>Этажность: {{ property.building_floors
                            }}</span>
                    </div>
                    {% endif %}
                    {% if property.has_balcony is defined %}
                    <div class="info-item">
                        <i class="fas fa-border-all"></i>
                        <span>Балкон: {% if property.has_balcony
                            %}Есть{% else %}Нет{% endif %}</span>
                    </div>
                    {% endif %}
                    {% if property.has_furniture is defined %}
                    <div class="info-item">
                        <i class="fas fa-couch"></i>
                        <span>Мебель: {% if property.has_furniture
                            %}Есть{% else %}Нет{% endif %}</span>
                    </div>
                    {% endif %}
                    {% if property.has_renovation is defined %}
                    <div class="info-item">
                        <i class="fas fa-paint-roller"></i>
                        <span>Ремонт: {% if property.has_renovation
                            %}Есть{% else %}Нет{% endif %}</span>
                    </div>
                    {% endif %}
                    {% if property.has_parking is defined %}
                    <div class="info-item">
                        <i class="fas fa-parking"></i>
                        <span>Парковка: {% if property.has_parking
                            %}Есть{% else %}Нет{% endif %}</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="publication-info bg-gray-50 rounded-lg p-4 mb-6">
                <h3 class="text-gray-800 font-medium mb-3">
                    <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                    Информация о публикации
                </h3>
                <div class="grid grid-cols-1 gap-2 text-sm">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">Дата публикации:</span>
                        <span class="font-medium">{{ property.created_at or 'Не указана' }}</span>
                    </div>
                </div>
            </div> 

            <!-- Карта местоположения -->
            {% if property.latitude and property.longitude %}
            <div class="map-section">
                <div class="map-header">
                    <h3 class="map-title">
                        <i class="fas fa-map-marker-alt"></i>
                        Местоположение
                    </h3>
                </div>
                <div class="property-map-container" id="property-map"></div>
                <div class="map-actions">
                    <a href="https://www.google.com/maps?q={{ property.latitude }},{{ property.longitude }}" 
                       target="_blank" class="map-btn">
                        <i class="fas fa-external-link-alt"></i>
                        Открыть в Google Maps
                    </a>
                    <a href="https://www.google.com/maps/dir/?api=1&destination={{ property.latitude }},{{ property.longitude }}"
                       target="_blank" class="map-btn">
                        <i class="fas fa-route"></i>
                        Проложить маршрут
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Контакты продавца -->
            <div class="seller-info">
                <div class="avatar">
                    {% if property.owner.is_company and property.owner.logo_url %}
                    <img src="{{ property.owner.logo_url }}" alt="Логотип компании">
                    {% elif property.owner.is_company %}
                    <div class="bg-orange-100 text-orange-600 rounded-full w-12 h-12 flex items-center justify-center">
                        <i class="fas fa-building text-lg"></i>
                    </div>
                    {% else %}
                    <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?q=80&w=100&auto=format&fit=crop" alt="Фото продавца">
                    {% endif %}
                </div>
                <div>
                    <div class="seller-name">
                        {% if property.owner.is_company %}
                            {{ property.owner.company_name or 'Компания' }}
                        {% else %}
                            {{ property.owner.full_name or 'Пользователь' }}
                        {% endif %}
                    </div>
                    <div class="text-gray-500 text-sm">
                        {% if property.owner.is_company %}
                            Компания
                        {% else %}
                            Продавец
                        {% endif %}
                    </div>
                </div>
                <a href="tel:{{ property.owner.phone }}" class="call-btn">
                    <i class="fas fa-phone-alt mr-1"></i> Позвонить
                </a>
            </div>

            <!-- Кнопки действий -->
            <div class="grid grid-cols-1 gap-3 mb-6">
                {% if property.owner and property.owner.id and not property.is_owner %}
                <a
                    href="{{ url_for('chat', user_id=property.owner.id) }}?property_id={{ property.id }}"
                    class="action-btn primary">
                    <i class="far fa-comments mr-2"></i> Написать
                    сообщение
                </a>
                {% endif %}
            </div>

            <!-- Похожие объявления -->
            <div class="similar-properties">
                <h3 class="similar-title">
                    Похожие объявления
                </h3>
                <div class="grid grid-cols-2 gap-3">
                    {% for prop in similar_properties %}
                    <a href="{{ url_for('property', property_id=prop.id) }}" class="block no-underline">
                        <div class="property-card hover:shadow-md transition-shadow">
                            <div class="property-card-img">
                                <img
                                    src="{{ prop.image_url }}"
                                    alt="Фото объекта">
                            </div>
                            <div class="property-card-body">
                                <div class="property-card-price">
                                    {{ '{:,.0f}'.format(prop.price) }}
                                    СОМ
                                </div>
                                <div class="property-card-title">
                                    {{ prop.title }}
                                </div>
                                <div class="property-card-address">
                                    {{ prop.address }}
                                </div>
                                <div class="property-card-specs">
                                    {% if prop.rooms %}
                                    <div class="property-card-spec">
                                        <i class="fas fa-door-open"></i>
                                        {{ prop.rooms }}
                                    </div>
                                    {% endif %}
                                    {% if prop.area %}
                                    <div class="property-card-spec">
                                        <i
                                            class="fas fa-vector-square"></i>
                                        {{ prop.area }} м²
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для 360 просмотра -->
<div
    class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden"
    id="modal-360">
    <div
        class="bg-white rounded-lg w-full h-full md:w-4/5 md:h-4/5 relative overflow-hidden flex flex-col">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 class="text-lg font-medium">360° Просмотр</h3>
            <button id="close-360-modal"
                class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="flex-grow">
            {% if property.tour_360_url %}
            <!-- Если есть внешний URL (например Kuula) -->
            <iframe src="{{ property.tour_360_url }}" allowfullscreen
                class="w-full h-full"></iframe>
            {% elif property.tour_360_optimized_url %}
            <!-- Если есть загруженный файл, используем 360° viewer -->
            <div class="w-full h-full" id="panorama-container">
                <div id="panorama-sphere" style="width: 100%; height: 100%;"></div>
            </div>
            {% else %}
            <div
                class="flex items-center justify-center h-full bg-gray-100">
                <div class="text-center p-5">
                    <i
                        class="fas fa-vr-cardboard text-gray-400 text-5xl mb-3"></i>
                    <p class="text-gray-500">360° панорама недоступна
                        для этого объявления</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCgctqtqKOus6A6cDJaOBqsyo4-3r3zuQA&libraries=places&language=ru&region=KG" async defer></script>

<div id="page-data" 
     data-has-tour360="{% if property.has_360 %}true{% else %}false{% endif %}"
     data-property-price="{{ property.price|int }}"
     data-property-latitude="{% if property.latitude %}{{ property.latitude }}{% else %}42.8746{% endif %}"
     data-property-longitude="{% if property.longitude %}{{ property.longitude }}{% else %}74.5698{% endif %}"
     data-property-title="{{ property.title|e }}"
     data-property-address="{{ property.address|e }}"
     style="display:none;"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Инициализация слайдеров...');
    
    // Инициализация основного Swiper слайдера
    var mainSwiper = null;
    if (document.querySelector('.main-swiper')) {
        try {
            mainSwiper = new Swiper('.main-swiper', {
                loop: true,
                autoplay: {
                    delay: 4000,
                    disableOnInteraction: false
                },
                pagination: {
                    el: '.swiper-pagination',
                    clickable: true
                },
                keyboard: true,
                grabCursor: true,
                speed: 300
            });
            
            console.log('Swiper инициализирован');
            
            // Синхронизация с миниатюрами
            mainSwiper.on('slideChange', function() {
                var index = this.realIndex;
                var thumbnails = document.querySelectorAll('.thumbnail');
                thumbnails.forEach(function(thumb) {
                    thumb.classList.remove('active');
                });
                var activeThumbnail = document.querySelector('.thumbnail[data-index="' + index + '"]');
                if (activeThumbnail) {
                    activeThumbnail.classList.add('active');
                }
            });
            
        } catch (error) {
            console.error('Ошибка Swiper:', error);
        }
    }
    
    // Обработчик кликов по миниатюрам
    var thumbnails = document.querySelectorAll('.thumbnail');
    thumbnails.forEach(function(thumbnail) {
        thumbnail.addEventListener('click', function() {
            var index = parseInt(this.getAttribute('data-index'));
            if (mainSwiper) {
                mainSwiper.slideTo(index + 1);
                thumbnails.forEach(function(thumb) {
                    thumb.classList.remove('active');
                });
                this.classList.add('active');
            }
        });
    });
    
    // Рекламный слайдер
    var adsWrapper = document.querySelector('.ads-slides-wrapper');
    var adsSlides = document.querySelectorAll('.ads-slide');
    
    if (adsWrapper && adsSlides.length > 0) {
        var currentAdsSlide = 0;
        
        function showAdsSlide(index) {
            var translateX = -(index * 50);
            adsWrapper.style.transform = 'translateX(' + translateX + '%)';
        }
        
        function nextAdsSlide() {
            currentAdsSlide = (currentAdsSlide + 1) % adsSlides.length;
            showAdsSlide(currentAdsSlide);
        }
        
        setInterval(nextAdsSlide, 3000);
        console.log('Рекламный слайдер запущен');
    }
    
    // 💰 КОНВЕРТАЦИЯ ВАЛЮТ - НОВЫЙ КОД
    var pageData = document.getElementById('page-data');
    var originalPrice = parseInt(pageData.getAttribute('data-property-price')) || 0;  // Исходная цена в сомах
    var exchangeRate = 83;  // 1 USD = 83 KGS
    var currentCurrency = 'СОМ';
    
    var currencyContainer = document.getElementById('currency-container');
    var currencyDropdown = document.getElementById('currency-dropdown');
    var currencyLabel = document.getElementById('currency-label');
    var priceValue = document.getElementById('price-value');
    var currencyOptions = document.querySelectorAll('.currency-option');
    
    console.log('Инициализация конвертера валют...');
    console.log('Исходная цена:', originalPrice, 'сом');
    console.log('Курс обмена: 1 USD =', exchangeRate, 'KGS');
    
    // Показать/скрыть dropdown при клике
    if (currencyContainer) {
        currencyContainer.addEventListener('click', function(e) {
            e.stopPropagation();
            currencyDropdown.classList.toggle('show');
            console.log('Dropdown переключен');
        });
    }
    
    // Закрыть dropdown при клике вне его
    document.addEventListener('click', function() {
        if (currencyDropdown) {
            currencyDropdown.classList.remove('show');
        }
    });
    
    // Обработка выбора валюты
    currencyOptions.forEach(function(option) {
        option.addEventListener('click', function(e) {
            e.stopPropagation();
            
            var selectedCurrency = this.getAttribute('data-currency');
            console.log('Выбрана валюта:', selectedCurrency);
            
            // Убираем active класс у всех опций
            currencyOptions.forEach(function(opt) {
                opt.classList.remove('active');
            });
            
            // Добавляем active класс к выбранной опции
            this.classList.add('active');
            
            // Обновляем отображение
            currencyLabel.textContent = selectedCurrency;
            currentCurrency = selectedCurrency;
            
            // Конвертируем цену
            var newPrice;
            if (selectedCurrency === 'USD') {
                newPrice = Math.round(originalPrice / exchangeRate);
                console.log('Конвертация в USD:', originalPrice, '/', exchangeRate, '=', newPrice);
            } else {
                newPrice = originalPrice;
                console.log('Показываем исходную цену в сомах:', newPrice);
            }
            
            // Обновляем отображение цены
            priceValue.textContent = newPrice.toLocaleString();
            
            // Закрываем dropdown
            currencyDropdown.classList.remove('show');
            
            console.log('Цена обновлена:', newPrice, selectedCurrency);
        });
    });
    
    // Google Maps инициализация
    setTimeout(function() {
        if (typeof google !== 'undefined' && document.getElementById('property-map')) {
            var pageData = document.getElementById('page-data');
            var lat = parseFloat(pageData.getAttribute('data-property-latitude')) || 42.8746;
            var lng = parseFloat(pageData.getAttribute('data-property-longitude')) || 74.5698;
            var title = pageData.getAttribute('data-property-title') || 'Объявление';
            var address = pageData.getAttribute('data-property-address') || 'Адрес не указан';
            
            var location = { lat: lat, lng: lng };
            
            var map = new google.maps.Map(document.getElementById('property-map'), {
                zoom: 16,
                center: location,
                mapTypeControl: true,
                streetViewControl: true,
                fullscreenControl: true
            });
            
            var marker = new google.maps.Marker({
                position: location,
                map: map,
                title: title,
                icon: {
                    url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
                    scaledSize: new google.maps.Size(32, 32)
                }
            });
            
            // Информационное окно с адресом
            var infoWindow = new google.maps.InfoWindow({
                content: '<div style="padding: 10px;"><h4>' + title + '</h4><p>' + address + '</p></div>'
            });
            
            marker.addListener('click', function() {
                infoWindow.open(map, marker);
            });
            
            console.log('Google Maps инициализирована с координатами:', location);
        } else {
            console.log('Google Maps API не загружен или элемент карты не найден');
        }
    }, 2000);
    
    // 🎯 ОБРАБОТЧИК 360° ПРОСМОТРА 
    var view360Btn = document.getElementById('view-360-btn');
    var modal360 = document.getElementById('modal-360');
    var close360Modal = document.getElementById('close-360-modal');
    
    if (view360Btn) {
        view360Btn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('🎯 Открываем модальное окно 360°');
            
            if (modal360) {
                modal360.classList.remove('hidden');
                
                // Если есть загруженный файл панорамы, инициализируем Pannellum
                var pageData = document.getElementById('page-data');
                var hasTour360 = pageData.getAttribute('data-has-tour360') === 'true';
                
                if (hasTour360) {
                    console.log('🎯 Инициализируем Pannellum для загруженной панорамы');
                    // Получаем URL оптимизированной панорамы из данных свойства
                    var panoramaUrl = '{{ property.tour_360_optimized_url }}';
                    
                    if (panoramaUrl && panoramaUrl !== 'None' && panoramaUrl.trim() !== '') {
                        setTimeout(function() {
                            try {
                                pannellum.viewer('panorama-sphere', {
                                    "type": "equirectangular",
                                    "panorama": panoramaUrl,
                                    "autoLoad": true,
                                    "hotSpotDebug": false,
                                    "showControls": true,
                                    "mouseZoom": true,
                                    "doubleClickZoom": true,
                                    "draggable": true,
                                    "keyboardZoom": true,
                                    "showFullscreenCtrl": true,
                                    "showZoomCtrl": true,
                                    "yaw": 0,
                                    "pitch": 0,
                                    "hfov": 90
                                });
                                console.log('✅ Pannellum успешно инициализирован');
                            } catch (error) {
                                console.error('❌ Ошибка инициализации Pannellum:', error);
                            }
                        }, 100);
                    } else {
                        console.log('⚠️ URL панорамы отсутствует');
                    }
                }
            } else {
                console.log('❌ Модальное окно 360° не найдено');
            }
        });
    } else {
        console.log('⚠️ Кнопка 360° не найдена');
    }
    
    // Закрытие модального окна 360°
    if (close360Modal) {
        close360Modal.addEventListener('click', function() {
            console.log('🎯 Закрываем модальное окно 360°');
            if (modal360) {
                modal360.classList.add('hidden');
            }
        });
    }
    
    // Закрытие по клику вне модального окна
    if (modal360) {
        modal360.addEventListener('click', function(e) {
            if (e.target === modal360) {
                console.log('🎯 Закрываем модальное окно 360° (клик вне)');
                modal360.classList.add('hidden');
            }
        });
    }
    
    // 🔥 АВТОМАТИЧЕСКОЕ ОТКРЫТИЕ 360° при наличии параметра auto360=1
    var urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('auto360') === '1' && view360Btn) {
        console.log('🎯 Автоматически открываем 360° просмотр');
        setTimeout(function() {
            view360Btn.click();
        }, 500); // Небольшая задержка для загрузки страницы
    }
});
</script>
{% endblock %}
